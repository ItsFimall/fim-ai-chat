# 数据库重置功能使用指南

## 🎯 功能概述

管理员现在可以通过Web界面安全地重置整个数据库，这个功能包含了多重安全确认机制，确保不会意外执行危险操作。

## 🔐 安全机制

### 1. 权限验证
- 只有具有管理员权限的用户才能访问此功能
- API会验证用户的管理员身份

### 2. 确认对话框
- 显示详细的操作后果说明
- 列出所有将被删除的数据类型
- 要求输入确认文本 `RESET DATABASE`

### 3. 文本确认
- 必须准确输入 `RESET DATABASE` 才能继续
- 防止误操作和意外点击

## 📍 访问路径

1. 以管理员身份登录系统
2. 访问配置页面：`/config`
3. 切换到"系统设置"标签页
4. 在"危险操作"区域找到"重置数据库"按钮

## ⚠️ 重置操作影响

数据库重置将会：

- ✅ **删除所有用户账户**（包括管理员）
- ✅ **删除所有聊天对话记录**
- ✅ **删除所有邀请码和访问码**
- ✅ **删除所有Token使用统计**
- ✅ **重建数据库结构**
- ✅ **重新种子默认数据**（提供商和模型）

## 🚀 操作步骤

### 步骤1：点击重置按钮
在管理员面板的系统设置页面，点击红色的"🗑️ 重置数据库"按钮。

### 步骤2：查看确认信息
系统会显示一个确认对话框，包含：
- 操作警告信息
- 详细的影响列表
- 文本确认输入框

### 步骤3：输入确认文本
在输入框中准确输入：`RESET DATABASE`

### 步骤4：确认执行
点击"确认重置"按钮执行操作。

### 步骤5：等待完成
- 系统会显示"处理中..."状态
- 重置完成后会显示成功消息
- 页面将在3秒后自动跳转到首页

## 🔄 重置后的状态

### 数据库状态
- 所有表被清空并重建
- 默认的AI提供商和模型被重新添加
- 管理员邀请码 `fimai_ADMIN_MASTER_KEY` 重新可用

### 用户状态
- 所有用户账户被删除
- 需要重新使用管理员邀请码注册第一个管理员
- 所有聊天历史和设置丢失

## 🛠️ 技术实现

### API端点
- `GET /api/admin/database/reset` - 获取重置信息
- `POST /api/admin/database/reset` - 执行数据库重置

### 执行的命令
```bash
npm run db:reset  # 重置数据库结构
npm run db:seed   # 重新种子数据
```

### 安全验证
```javascript
// 权限检查
const hasPermission = await checkUserPermission(adminUserId, 'admin_panel')

// 确认文本验证
if (confirmText !== 'RESET DATABASE') {
  return error('Invalid confirmation text')
}
```

## 📋 使用场景

### 适用情况
- 开发环境测试重置
- 数据损坏需要重建
- 系统迁移前的清理
- 演示环境的定期重置

### 不适用情况
- 生产环境的日常维护
- 仅删除部分数据
- 数据备份和恢复

## ⚡ 快速测试

### 测试步骤
1. 确保已有管理员账户
2. 登录管理员账户
3. 访问 `/config` 页面
4. 切换到"系统设置"标签
5. 点击"重置数据库"按钮
6. 按照提示完成确认
7. 等待重置完成
8. 验证数据库已被重置

### 验证方法
- 尝试用原账户登录（应该失败）
- 检查管理员邀请码是否可用
- 确认聊天历史已清空
- 验证默认模型已重新添加

## 🔧 故障排除

### 常见问题

**问题1：权限被拒绝**
- 确认当前用户是管理员
- 检查用户状态是否为活跃

**问题2：确认文本不匹配**
- 确保输入的是 `RESET DATABASE`（区分大小写）
- 检查是否有多余的空格

**问题3：重置失败**
- 检查数据库连接
- 确认npm脚本可以正常执行
- 查看服务器日志获取详细错误信息

**问题4：重置后无法访问**
- 这是正常现象，所有用户都被删除了
- 使用管理员邀请码重新注册管理员账户

## 🎯 最佳实践

1. **备份重要数据**：重置前确保重要数据已备份
2. **通知用户**：在生产环境执行前通知所有用户
3. **选择合适时机**：在用户活动较少时执行
4. **测试环境验证**：先在测试环境验证操作流程
5. **准备恢复计划**：制定数据恢复的应急方案

## 🚨 注意事项

- ⚠️ **此操作不可逆**：一旦执行无法撤销
- ⚠️ **数据永久丢失**：所有用户数据将被永久删除
- ⚠️ **服务中断**：重置期间服务可能短暂不可用
- ⚠️ **重新配置**：重置后需要重新配置所有设置

---

**重要提醒**：数据库重置是一个极其危险的操作，请确保您完全理解其后果并已做好充分准备再执行此操作！
